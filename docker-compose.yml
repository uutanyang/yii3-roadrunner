services:
  # ============================================================
  # PHP / RoadRunner 应用服务
  # ============================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${APP_CONTAINER_NAME:-yii3_app}
    volumes:
      - ./src:/app
      - ./.rr.yaml:/app/.rr.yaml
    environment:
      # Yii3 应用环境配置
      APP_ENV: ${APP_ENV:-dev}
      APP_DEBUG: ${APP_DEBUG:-false}

      # PostgreSQL 数据库配置
      DB_DSN: pgsql:host=${DB_HOST:-postgres};port=${DB_PORT:-5432};dbname=${DB_NAME:-yii_db}
      DB_USERNAME: ${DB_USER:-yii_user}
      DB_PASSWORD: ${DB_PASSWORD}

      # MinIO 对象存储配置
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET:-yii-bucket}

      # NATS 消息队列配置
      NATS_DSN: ${NATS_URL:-nats://nats:4222}
      NATS_JETSTREAM_ENABLED: ${NATS_JETSTREAM_ENABLED:-1}

    ports:
      - "${APP_HTTP_PORT:-8080}:8080"

    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      nats:
        condition: service_healthy

    networks:
      - caoguo-yii3-net

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '${APP_CPU_LIMIT:-1.0}'
          memory: ${APP_MEMORY_LIMIT:-512m}
        reservations:
          cpus: '${APP_CPU_RESERVATION:-0.5}'
          memory: ${APP_MEMORY_RESERVATION:-256m}

    restart: ${RESTART_POLICY:-unless-stopped}

  # ============================================================
  # Nginx 反向代理服务
  # ============================================================
  nginx:
    image: nginx:${NGINX_VERSION:-alpine}
    container_name: ${NGINX_CONTAINER_NAME:-yii3_nginx}
    ports:
      - "${NGINX_HTTP_PORT:-80:80}"
    volumes:
      - ./src/public:/app/public
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      app:
        condition: service_healthy
    networks:
      - caoguo-yii3-net

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: '${NGINX_CPU_LIMIT:-0.5}'
          memory: ${NGINX_MEMORY_LIMIT:-256m}
        reservations:
          cpus: '${NGINX_CPU_RESERVATION:-0.25}'
          memory: ${NGINX_MEMORY_RESERVATION:-128m}

    restart: ${RESTART_POLICY:-unless-stopped}

    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-100m}
        max-file: ${LOG_MAX_FILE:-10}

  # ============================================================
  # PostgreSQL 数据库服务
  # ============================================================
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:16-alpine}
    container_name: ${POSTGRES_CONTAINER_NAME:-yii3_postgres}
    environment:
      POSTGRES_DB: ${DB_NAME:-yii_db}
      POSTGRES_USER: ${DB_USER:-yii_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS:-200}
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS:-256MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}
      POSTGRES_LOG_MIN_DURATION_STATEMENT: ${POSTGRES_LOG_MIN_DURATION_STATEMENT:--1}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - ${POSTGRES_DATA_VOLUME:-pg_data}:/var/lib/postgresql/data
    networks:
      - caoguo-yii3-net

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-yii_user} -d ${DB_NAME:-yii_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '${POSTGRES_CPU_LIMIT:-1.0}'
          memory: ${POSTGRES_MEMORY_LIMIT:-1g}
        reservations:
          cpus: '${POSTGRES_CPU_RESERVATION:-0.5}'
          memory: ${POSTGRES_MEMORY_RESERVATION:-512m}

    restart: ${RESTART_POLICY:-unless-stopped}

    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-100m}
        max-file: ${LOG_MAX_FILE:-10}

  # ============================================================
  # MinIO 对象存储服务
  # ============================================================
  minio:
    image: ${MINIO_IMAGE:-minio/minio:latest}
    container_name: ${MINIO_CONTAINER_NAME:-yii3_minio}
    command: server /data --console-address ":9001" --address ":9000"
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
      MINIO_REGION: ${MINIO_REGION:-us-east-1}
      MINIO_SERVER_URL: ${MINIO_SERVER_URL:-http://localhost:9000}
    volumes:
      - ${MINIO_DATA_VOLUME:-minio_data}:/data
    networks:
      - caoguo-yii3-net

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: '${MINIO_CPU_LIMIT:-1.0}'
          memory: ${MINIO_MEMORY_LIMIT:-1g}
        reservations:
          cpus: '${MINIO_CPU_RESERVATION:-0.5}'
          memory: ${MINIO_MEMORY_RESERVATION:-512m}

    restart: ${RESTART_POLICY:-unless-stopped}

    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-100m}
        max-file: ${LOG_MAX_FILE:-10}

  # ============================================================
  # NATS 消息队列服务（JetStream）
  # ============================================================
  nats:
    image: ${NATS_IMAGE:-nats:latest}
    container_name: ${NATS_CONTAINER_NAME:-yii3_nats}
    command: -js -sd /data -m ${NATS_MONITORING_PORT:-8222}
    ports:
      - "${NATS_PORT:-4222}:4222"
      - "${NATS_MONITORING_PORT:-8222}:8222"
    environment:
      NATS_MAX_PAYLOAD: ${NATS_MAX_PAYLOAD:-1048576}
      NATS_MAX_CONNECTIONS: ${NATS_MAX_CONNECTIONS:-65536}
    volumes:
      - ${NATS_DATA_VOLUME:-nats_data}:/data
    networks:
      - caoguo-yii3-net

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${NATS_MONITORING_PORT:-8222}/varz"]
      interval: 10s
      timeout: 5s
      retries: 5

    deploy:
      resources:
        limits:
          cpus: '${NATS_CPU_LIMIT:-0.5}'
          memory: ${NATS_MEMORY_LIMIT:-512m}
        reservations:
          cpus: '${NATS_CPU_RESERVATION:-0.25}'
          memory: ${NATS_MEMORY_RESERVATION:-256m}

    restart: ${RESTART_POLICY:-unless-stopped}

    logging:
      driver: ${LOG_DRIVER:-json-file}
      options:
        max-size: ${LOG_MAX_SIZE:-100m}
        max-file: ${LOG_MAX_FILE:-10}

  # ============================================================
  # MinIO 客户端（用于自动创建 bucket）
  # ============================================================
  minio-client:
    image: minio/mc:latest
    container_name: ${MINIO_CLIENT_CONTAINER_NAME:-yii3_minio_client}
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      /usr/bin/mc alias set myminio http://${MINIO_ENDPOINT:-minio:9000} ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY};
      /usr/bin/mc mb myminio/${MINIO_BUCKET:-yii-bucket} --ignore-existing;
      /usr/bin/mc policy set public myminio/${MINIO_BUCKET:-yii-bucket};
      echo 'MinIO bucket ${MINIO_BUCKET:-yii-bucket} created successfully';
      exit 0;
      "
    networks:
      - caoguo-yii3-net

    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128m
        reservations:
          cpus: '0.1'
          memory: 64m

    restart: "no"

networks:
  caoguo-yii3-net:
    name: ${NETWORK_NAME:-caoguo-yii3-net}
    driver: ${NETWORK_DRIVER:-bridge}

volumes:
  pg_data:
    name: ${POSTGRES_DATA_VOLUME:-pg_data}
    driver: local
  minio_data:
    name: ${MINIO_DATA_VOLUME:-minio_data}
    driver: local
  nats_data:
    name: ${NATS_DATA_VOLUME:-nats_data}
    driver: local
