# ============================================================
# 多阶段构建：RoadRunner
# ============================================================
FROM ghcr.io/roadrunner-server/roadrunner:2025.1.6 AS roadrunner

# ============================================================
# 多阶段构建：Composer
# ============================================================
FROM composer:2 AS composer

# ============================================================
# 多阶段构建：基础镜像
# ============================================================
FROM php:8.3-cli-alpine AS base

# ============================================================
# 安装系统依赖
# ============================================================
RUN set -e \
    && apk update \
    && apk add --no-cache \
        postgresql-dev \
        postgresql-libs \
        libzip-dev \
        libzip \
        oniguruma-dev \
        autoconf \
        g++ \
        make \
        curl \
        unzip \
        git \
        openssh-server \
        icu-dev \
        icu-data-full \
        bash \
        tzdata

# ============================================================
# 安装 PHP 扩展
# ============================================================
RUN set -e \
    && docker-php-ext-install \
        pdo \
        pdo_pgsql \
        mbstring \
        intl \
        zip \
        bcmath \
        opcache

# ============================================================
# 安装 PECL 扩展
# ============================================================
RUN set -e \
    && pecl install igbinary \
    && docker-php-ext-enable igbinary \
    && pecl install msgpack \
    && docker-php-ext-enable msgpack

# ============================================================
# 清理临时文件
# ============================================================
RUN set -e \
    && rm -rf /var/cache/apk/* \
    && rm -rf /tmp/pear \
    && docker-php-source delete

# ============================================================
# 设置语言和时区
# ============================================================
ENV LANG=zh_CN.UTF-8 \
    LANGUAGE=zh_CN:zh \
    LC_ALL=zh_CN.UTF-8 \
    TZ=Asia/Shanghai

# ============================================================
# 复制 Composer
# ============================================================
COPY --from=composer /usr/bin/composer /usr/bin/composer

# ============================================================
# 设置工作目录
# ============================================================
WORKDIR /app

# ============================================================
# 开发环境
# ============================================================
FROM base AS dev

# ============================================================
# 复制 RoadRunner 二进制文件
# ============================================================
COPY --from=roadrunner /usr/bin/rr /usr/local/bin/rr

# ============================================================
# 复制 MinIO 客户端（如果需要）
# ============================================================
# 注意：此步骤需要确保 roadrunner 镜像包含 mc
# 如果 roadrunner 镜像没有 mc，此命令会失败但不影响构建
# COPY --from=roadrunner /usr/local/bin/mc /usr/local/bin/mc

# ============================================================
# 暴露端口
# ============================================================
EXPOSE 8080

# ============================================================
# 设置入口点
# ============================================================
ENTRYPOINT ["sh", "-c", "if [ -f /app/.rr.yaml ]; then rr serve -d -c /app/.rr.yaml; else echo 'No .rr.yaml found, starting PHP built-in server...'; php -S 0.0.0.0:8080 -t /app/public 2>/dev/null || php -S 0.0.0.0:8080; fi"]
