# ============================================================
# 多阶段构建：RoadRunner
# ============================================================
FROM ghcr.io/roadrunner-server/roadrunner:2025.1.6 AS roadrunner

# ============================================================
# 多阶段构建：Composer
# ============================================================
FROM composer:latest AS composer

# ============================================================
# 多阶段构建：基础镜像
# ============================================================
FROM php:8.4-cli-alpine AS base

# ============================================================
# 安装系统依赖
# ============================================================
RUN apk add --no-cache \
    postgresql-libs \
    libzip-dev \
    oniguruma-dev \
    linux-headers \
    icu-dev \
    icu-data-full

# ============================================================
# 安装 PHP 扩展
# ============================================================
RUN docker-php-ext-install \
    pdo_mysql \
    mbstring \
    intl \
    zip \
    sockets \
    opcache

# ============================================================
# 复制 Composer
# ============================================================
COPY --from=composer /usr/bin/composer /usr/bin/composer

# ============================================================
# 设置工作目录
# ============================================================
WORKDIR /app

# ============================================================
# 开发环境
# ============================================================
FROM base AS dev

# ============================================================
# 复制 RoadRunner 二进制文件
# ============================================================
COPY --from=roadrunner /usr/bin/rr /usr/local/bin/rr

# ============================================================
# 暴露端口
# ============================================================
EXPOSE 8080

# ============================================================
# 设置入口点
# ============================================================
CMD ["rr", "serve", "-d", "-c", ".rr.yaml"]